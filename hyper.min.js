
function start_hyper(e = { timeOut: 500 }) {
  $("#testar").html("Please wait....");

  let r = $("#lista").val().split("\n").filter(Boolean);
  let l = r.length, s = 0, i = 0, c = 0, d = 0;

  // Group into chunks of 5 lines
  let chunks = [];
  for (let j = 0; j < r.length; j += 5) {
    let group = r.slice(j, j + 5);
    while (group.length < 5) group.push("null");
    chunks.push(group);
  }

  chunks.forEach(function (chunk, index) {
    setTimeout(function () {
      let params = chunk.map((line, idx) => `lista${idx + 1}=${encodeURIComponent(line)}`).join("&");

      $.ajax({
        url: `gate.php?${params}`,
        type: "GET",
        async: true,
        success: function (e) {
          // Remove only non-null lines
          let currentList = $("#lista").val().split("\n").filter(Boolean);
          let removeCount = chunk.filter(line => line !== "null").length;
          currentList.splice(0, removeCount);
          $("#lista").val(currentList.join("\n"));

          // Response handling
          if (e.match("#LIVE")) {
            d++;
            charged(e + "<br>");
            tata.success("", e + "<br>", { duration: 5000 });
          } else if (e.match("#CVV")) {
            s++;
            aprovadas(e + "<br>");
            tata.success("", e + "<br>", { duration: 5000 });
          } else if (e.match("#CCN")) {
            i++;
            edrovadas(e + "<br>");
          } else {
            c++;
            reprovadas(e + "<br>");
          }

          let t = d + s + i + c;
          let percent = (t / l) * 100;

          $("#carregadas").html(l);
          $("#cLive").html(s);
          $("#cWarn").html(i);
          $("#cDie").html(c);
          $("#total").html(t);
          $("#cLive3").html(d);
          $("#cLive2").html(s);
          $("#cWarn2").html(i);
          $("#cDie2").html(c);
          $(".gline").css({ width: percent.toFixed(0) + "%" });
          $("#testar").html(percent === 100 ? "✅ completed !" : `[${t}] processing ${percent.toFixed(0)}%`);
        },
        error: function () {
          let currentList = $("#lista").val().split("\n").filter(Boolean);
          let removeCount = chunk.filter(line => line !== "null").length;
          currentList.splice(0, removeCount);
          $("#lista").val(currentList.join("\n"));

          c += removeCount;
          reprovadas("❌ Request failed");
        },
      });
    }, e.timeOut * index);
  });
}

function charged(e) {
  $(".charged").append(e + "");
}

function aprovadas(e) {
  $(".aprovadas").append(e + "");
}

function reprovadas(e) {
  $(".reprovadas").append(e + "");
}

function edrovadas(e) {
  $(".edrovadas").append(e + "");
}

function removelinha() {
  var e = $("#lista").val().split("\n");
  e.splice(0, 1);
  $("#lista").val(e.join("\n"));
}

$(document).ready(function () {
  $("#bode").hide();
  $("#bode4").hide();
  $("#esconde").show();

  $("#mostra4").click(function () {
    $("#bode4").slideToggle();
  });
  $("#mostra").click(function () {
    $("#bode").slideToggle();
  });
  $("#mostra3").click(function () {
    $("#bode3").slideToggle();
  });
  $("#mostra2").click(function () {
    $("#bode2").slideToggle();
  });
});